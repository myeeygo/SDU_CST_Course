
# SM3 哈希算法优化实现说明文档

## 概述
本项目针对 SM3 哈希算法进行优化实现。该实现通过 AVX2 SIMD 指令集、循环展开等技术显著提升了算法性能。

### SM3 哈希算法简介
SM3算法属于密码学中的哈希函数，主要用于数据完整性校验、数字签名等场景。通过对输入消息进行一系列复杂的压缩变换，最终生成固定长度的哈希值，具体流程如下：

1. **消息填充**
   - 对输入消息进行预处理，确保其长度为512比特的整数倍。
   - 填充规则：先在消息末尾添加一个“1”，再添加若干个“0”，最后添加64比特的消息原始长度（以比特为单位）

2. **消息分组**
   - 将填充后的消息按512比特为单位分成`n`个分组`M_0, M_1, ..., M_{n-1}`。

3. **压缩函数处理**
   - 初始化一个256比特的初始哈希值`IV`（固定值：`7380166f 4914b2b9 172442d7 da8a0600 a96f30bc 163138aa e38dee4d b0fb0e4e`）。
   - 对每个分组`M_i`，通过压缩函数`CF`更新哈希值：`V_{i+1} = CF(V_i, M_i)`，其中`V_0 = IV`。
   - 压缩函数内部包含消息扩展和迭代压缩两个步骤：
     - **消息扩展**：将512比特的分组`M_i`扩展为132个32比特的字`W_0, W_1, ..., W_{67}`和`W'_0, W'_1, ..., W'_{63}`，用于后续迭代。
     - **迭代压缩**：基于扩展后的字，通过64轮迭代运算（每轮使用不同的常量和函数）更新中间状态，最终输出256比特的压缩结果。

4. **输出哈希值**
   - 所有分组处理完成后，最终的`V_n`即为输入消息的SM3哈希值，长度为**256比特**（32字节）。


## 优化技术解析

### 1. AVX2 SIMD 指令集优化
利用 Intel AVX2 指令集实现数据级并行处理，大幅提升计算效率。

#### 1.1 消息扩展函数优化 (`MessageExpansionAVX2`)
```cpp
void MessageExpansionAVX2(const uint32_t* block, uint32_t* W);
```
- **功能**：将 512 位输入块扩展为 132 个 32 位消息字（W[0..67] 和 W'[0..63]）。
- **优化点**：
  - **并行加载与存储**：使用 `_mm_loadu_si128` 和 `_mm_storeu_si128` 一次性处理 4 个 32 位字。
  - **字节序转换**：通过 `_mm_shuffle_epi8` 配合掩码快速完成大端到小端的转换。
  - **并行旋转移位**：使用 `_mm_slli_epi32` 和 `_mm_srli_epi32` 组合实现高效循环左移。
  - **并行计算 P1 函数**：通过向量操作并行计算 `P1(x) = x ^ ROTL32(x,15) ^ ROTL32(x,23)`。

#### 1.2 性能对比
| 操作         | 标量实现次数 | AVX2 实现次数 | 加速比 |
|--------------|--------------|---------------|--------|
| 消息字加载   | 68 次        | 17 次         | 4x     |
| 旋转移位计算 | 204 次       | 51 次         | 4x     |

### 2. 循环展开优化
在压缩函数 `SM3Compress` 中采用循环展开技术，减少循环控制开销。

#### 2.1 压缩函数优化
```cpp
void SM3Compress(uint32_t* V, const uint32_t* W);
```
- **功能**：对中间状态 V 进行 64 轮压缩。
- **优化点**：
  - **4 轮展开**：每轮循环处理 4 次迭代，减少循环控制指令 75%。
  - **寄存器变量**：使用局部变量存储中间状态（A-H），减少内存访问。

#### 2.2 展开示例
```cpp
// 前16轮展开
for (int j = 0; j < 16; j += 4) {
    SM3_ROUND(A, B, C, D, E, F, G, H, W[j + 68], j);
    SM3_ROUND(D, A, B, C, H, E, F, G, W[j + 1 + 68], j + 1);
    SM3_ROUND(C, D, A, B, G, H, E, F, W[j + 2 + 68], j + 2);
    SM3_ROUND(B, C, D, A, F, G, H, E, W[j + 3 + 68], j + 3);
}
```

### 3. 内联函数优化
关键函数使用 `inline` 修饰，减少函数调用开销：
```cpp
inline uint32_t ROTL32(uint32_t x, int n);  // 循环左移
inline uint32_t P1(uint32_t x);             // 消息扩展函数
inline uint32_t FF0(uint32_t x, uint32_t y, uint32_t z);  // 压缩函数FF (0-15轮)
inline uint32_t FF1(uint32_t x, uint32_t y, uint32_t z);  // 压缩函数FF (16-63轮)
```

### 4. 常量预计算
将 T 常量数组定义为 `constexpr`，在编译期完成计算：
```cpp
constexpr uint32_t T[64] = { /* ... */ };
```

# 运行输出示例
```
AVX2 Optimized SM3 Time: 0.0038057 seconds                                                                              Traditional SM3 Time:     0.0049764 seconds                                                                             Speedup Ratio:            1.30762  
```



