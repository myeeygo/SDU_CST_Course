# SM2椭圆曲线密码算法优化实现


## 概述

本项目对SM2椭圆曲线密码算法进行了Python优化实现，旨在提高其性能和安全性。SM2是中国密码标准组织发布的一种椭圆曲线密码算法，广泛应用于数字签名、密钥交换和数据加密等领域。



## 优化技术
### Tonelli-Shanks算法求解二次剩余
- **应用场景**：椭圆曲线点运算中求解`y² ≡ x³ + Ax + B mod Q`的`y`值（潜在需求，如解密或点恢复）。
- **传统方法问题**：对于大素数`Q`（SM2中`Q`为256位），暴力搜索二次剩余效率极低。
- **优化实现**：
  ```python
  def tonelli_shanks(n, p):
      # 针对p ≡ 3 mod 4的快速路径
      if p % 4 == 3:
          return pow(n, (p + 1) // 4, p)
          .......
  ```
- **优化原理**：
  - Tonelli-Shanks算法是求解模素数二次剩余的高效通用算法，时间复杂度为`O(log² p)`，远优于暴力搜索。
  - 针对`p ≡ 3 mod 4`的特殊情况（SM2中`Q ≡ 3 mod 4`），提供快速路径（`x = n^((p+1)/4) mod p`），进一步减少运算量。
- **收益**：将二次剩余求解从“不可行”变为“高效可行”，为椭圆曲线点的生成和恢复提供性能支撑。


### 扩展欧几里得算法求模逆
- **应用场景**：椭圆曲线加法中斜率计算（需求`(2y1)⁻¹ mod Q`或`(x2-x1)⁻¹ mod Q`）。
- **传统方法问题**：使用费马小定理`a⁻¹ ≡ a^(p-2) mod p`求逆，仅适用于`p`为素数的场景，且幂运算开销较高。
- **优化实现**：
  ```python
  def extended_euclidean(a, b):
      if b == 0:
          return (a, 1, 0)
      else:
          g, x, y = extended_euclidean(b, a % b)
          return (g, y, x - (a // b) * y)
  
  def mod_inverse(a, n):
      g, x, y = extended_euclidean(a, n)
      if g != 1:
          raise ValueError("逆元不存在")
      return x % n
  ```
- **优化原理**：
  - 扩展欧几里得算法直接通过辗转相除法求逆，时间复杂度为`O(log min(a, n))`，比费马小定理的幂运算（`O(log p)`次乘法）更高效。
  - 支持非素数模的逆元求解（虽然SM2中`Q`和`N`为素数，但通用性更强）。
- **收益**：减少模逆运算的开销，提升椭圆曲线加法和标量乘法的整体效率。


### 预计算Z_A减少重复哈希
- **应用场景**：签名和验证过程中对用户标识`ID`、曲线参数和公钥的哈希计算（`pre_compute`方法）。
- **重复计算问题**：签名和验证均需使用`Z_A = SM3(ENTL || ID || a || b || G || P)`，若每次调用都重新计算，会增加SM3哈希的重复开销。
- **优化实现**：
  ```python
  # 预计算Z_A并复用
  Z_A = SM2.pre_compute(...)
  signature = SM2.sign(..., Z_A, ...)  # 签名时直接传入Z_A
  ```
- **优化原理**：通过一次预计算将`Z_A`存储并复用，避免签名和验证过程中对相同参数的重复哈希运算（SM3为迭代哈希，256位输出，重复计算会浪费CPU资源）。
- **收益**：减少约50%的哈希计算量，提升签名-验证流程的整体效率。

## 输出示例

```
消息: this is atest mesage
公钥: (29800452773952149858300227630805197490048166795908762581081771155562628065213, 62502739916998871679124926768298699000553929957159703037713055093479537812962)
签名: (63738659366348290714340081986999640741606882835219922541770710056269532042897, 98546475174854926409887724600352710575243947343786090114437985793951922755381)
验证结果: 通过
```