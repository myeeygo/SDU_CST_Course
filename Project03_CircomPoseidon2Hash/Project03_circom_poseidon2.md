# Poseidon2哈希函数Circom实现文档

## 概述
这段代码实现了Poseidon2哈希函数的Circom电路模板。Poseidon2是一种专为零知识证明系统设计的哈希函数，具有高效、简洁的特点，特别适合在资源受限的环境中使用。

## 模块结构

### 基础组件

#### Sigma
- **功能**：实现5次幂S盒运算（x⁵）
- **数学原理**：使用两次平方和一次乘法实现高效的x⁵计算
- **代码逻辑**：
  ```
  in2 <== in * in;       // x²
  in4 <== in2 * in2;     // x⁴
  out <== in4 * in;      // x⁵
  ```

#### Ark (Add Round Key)
- **功能**：添加轮常量
- **参数**：
  - `t`：状态大小
  - `C`：轮常量数组
  - `r`：轮数索引
  - `isInternal`：是否为内部轮
- **逻辑**：
  - 内部轮：仅对第一个元素添加常量
  - 外部轮：对所有元素添加常量

#### MixE (外部轮线性层)
- **功能**：实现外部轮的线性变换
- **数学原理**：矩阵乘法，输出[i] = Σ(M[j][i] * in[j])
- **优化**：通过双重循环实现矩阵乘法

#### MixI (内部轮线性层)
- **功能**：实现内部轮的线性变换
- **优化**：利用输入总和预计算，减少乘法次数
- **代码逻辑**：
  ```
  sum += in[i];  // 预计算输入总和
  out[i] <== (M[i] - 1) * in[i] + sum;  // 优化计算
  ```

#### MixLast (输出混合层)
- **功能**：提取指定索引的输出值
- **用途**：从最终状态中选择特定输出

### 主组件

#### Poseidon2Ex (多输入多输出)
- **参数**：
  - `nInputs`：输入数量
  - `nOuts`：输出数量
- **工作流程**：
  1. 初始化状态：输入 + 初始状态
  2. 应用初始线性层
  3. 执行前半部分外部轮（全S盒）
  4. 执行内部轮（仅第一个元素有S盒）
  5. 执行后半部分外部轮
  6. 最终混合并输出结果
- **轮数配置**：
  - 外部轮总数：8轮
  - 内部轮数：根据状态大小查表确定

#### Poseidon2 (单输出封装)
- **功能**：封装Poseidon2Ex，提供单输出接口
- **默认设置**：初始状态设为0

## 数学原理

### S盒选择
- 使用5次幂S盒（x⁵）
- 满足d≥3且与p-1互质的条件，确保密码学安全性

### 轮函数设计
- 采用海绵结构（Sponge Construction）
- 外部轮：全S盒层 + 线性层 + 轮常量
- 内部轮：仅第一个元素有S盒，其余元素直接传递
- 线性层优化：内部轮使用特殊矩阵结构减少乘法次数

## 常量与参数
- 轮常量：从`poseidon2_constants.circom`导入
- 矩阵参数：包括外部轮矩阵、内部轮矩阵和最终混合矩阵
- 轮数配置：根据状态大小查表确定内部轮数

## 性能特点
- 高效的电路结构，减少约束数量
- 特别适合零知识证明系统
- 支持多输入多输出配置，灵活性高

