# DDH - based Private Intersection - Sum Protocol 代码说明文档

## 概述
本代码实现了基于离散对数困难问题（DDH）的私有交集和（Private Intersection - Sum）协议。该协议允许两个参与方（P1和P2）在保护各自数据隐私的前提下，计算出双方标识符集合的交集，并求出交集中对应数值的和。其中，P1持有标识符集合，P2持有标识符 - 数值对集合。

## 代码框架
### 参数定义
1. **群G参数**：
    - `G_p = 23`：定义了素数阶群G的模数，群G基于该素数构建。
    - `G_q = 11`：群G的阶，满足`G_p - 1`是`G_q`的倍数（`23 - 1 = 22 = 2×11` ），保证群的结构符合素数阶群要求。
    - `G_g = 2`：群G的生成元，满足`G_g^G_q ≡ 1 mod G_p`，用于构建群元素。
2. **Paillier同态加密参数**：
    - `paillier_p = 101`和`paillier_q = 103`：用于构建Paillier同态加密方案的两个大素数，选择较大素数增强安全性

### 哈希函数 `H`

功能：将输入的标识符通过SHA256哈希算法转换为字节串，再转换为整数，最后映射到群G的指数范围，通过生成元`G_g`的幂运算得到群G中的一个元素。作用是将标识符空间的元素映射到群G的元素，为后续协议步骤做准备。

### Paillier同态加密类 `Paillier`

- **初始化方法 `__init__`**：根据输入参数区分加密方和解密方初始化。若提供`p`和`q`，作为解密方初始化，计算出私钥相关参数（`lam`和`mu` ）；若提供`n`和`g`，作为加密方初始化，仅保存公钥参数。
- **加密方法 `encrypt`**：加密方使用，对明文`m`进行加密，生成密文。通过随机数`r`和公钥参数`n`、`g`，利用Paillier加密算法生成密文，同时检查明文范围。
- **解密方法 `decrypt`**：解密方使用，利用私钥参数`lam`和`mu`对密文`c`进行解密，恢复出明文。
- **同态加法方法 `add`**：支持密文的同态加法操作，即对两个密文对应的明文之和进行加密，结果仍为密文。
- **密文刷新方法 `refresh`**：加密方使用，通过随机数对密文进行随机化处理，增加密文随机性，防止通过密文模式推断明文。

### 协议模拟函数 `simulate_protocol`

1. **模拟双方输入**：定义P1的标识符集合`P1_V`和P2的标识符 - 数值对集合`P2_W`，模拟实际应用中双方的输入数据。
2. **Setup阶段**：P1和P2分别选择私钥`k1`和`k2`，P2生成Paillier密钥对，并将公钥`pk`发送给P1。
3. **Round 1（P1 → P2）**：P1对其标识符集合中的每个元素，先通过哈希函数`H`映射到群G元素，再用私钥`k1`进行幂运算，将结果打乱顺序后发送给P2（模拟为保存在列表`S1` ）。
4. **Round 2（P2 → P1）**：P2对收到的P1发送的元素用私钥`k2`进行幂运算生成`Z`并打乱；同时对自身标识符 - 数值对集合处理，将标识符哈希后用`k2`幂运算，数值用Paillier加密，结果打乱后发送给P1（模拟为保存在列表`T` ）。
5. **Round 3（P1 → P2）**：P1用公钥初始化Paillier，通过计算寻找交集（判断元素是否在`Z`中 ），对交集中的数值密文进行同态加法，然后刷新密文，发送给P2。
6. **Output（P2解密）**：P2对收到的密文进行解密，得到交集和，并输出交集元素、理论交集和（用于验证）以及解密结果。

## 示例输出
```
Paillier公钥: n=10403, g=10404
交集元素: ['b', 'd']
交集元素对应数值和: 7
解密结果: 7
```