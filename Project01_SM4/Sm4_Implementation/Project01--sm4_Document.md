# Project01--SM4实现  说明文档

## 概述
本代码文件实现了SM4对称加密算法的两种版本：传统实现和优化实现，并包含测试代码验证算法正确性。

## SM4算法概述
SM4算法是中国国家密码管理局于2012年发布的分组密码算法，主要用于无线局域网（WAPI）安全领域，现已成为国际标准ISO/IEC 18033-3的一部分。该算法采用**128位分组长度**和**128位密钥长度**，属于Feistel结构的迭代型分组密码，共包含32轮非线性迭代运算。

### 核心技术特点
1. **对称加密体制**：加密和解密使用相同密钥，加解密过程结构相似，仅轮密钥使用顺序相反
2. **非线性变换**：包含S盒置换（8位输入/8位输出）和线性变换L函数，提供混淆与扩散特性
3. **密钥扩展**：通过固定参数FK和轮常数CK生成32个轮密钥，增强算法安全性
4. **分组加密**：明文按128位（16字节）分组处理，支持ECB、CBC等多种工作模式

## 代码文件框架
1. **传统SM4实现**：首先对基础的sm4算法进行了实现，包括S盒变换、线性变换L、循环左移等基本操作.

2. **优化SM4实现**：之后，对sm4算法进行优化，借鉴aes算法中t-table的思想，将步骤进行合并。在传统实现基础上进行性能优化,在保持相同的加密解密功能的前提下，提高了执行效率。

3. **测试验证**：最后，对比测试了两种实现的加密解密结果，保证了算法正确性.

## 优化SM4算法的优化部分

### 1. 预计算变换表（T表和T'表）
- **优化点**：在构造函数中预计算T变换和T'变换的查找表
- **实现代码**：
```cpp
// 预计算 T 表
for (int i = 0; i < 256; ++i) {
    unsigned int b = SM4_SBOX[i];
    unsigned int t = b << 24;
    T0[i] = t ^ rotateLeft(t, 2) ^ rotateLeft(t, 10) ^ rotateLeft(t, 18) ^ rotateLeft(t, 24);    
    ...
}

// 预计算 T' 表
for (int i = 0; i < 256; ++i) {
    unsigned int b = SM4_SBOX[i];
    unsigned int t = b << 24;
    T0_prime[i] = t ^ rotateLeft(t, 13) ^ rotateLeft(t, 23);    
    ...
}
```
- **优势**：将原本需要在加密过程中实时计算的非线性变换（S盒）和线性变换组合结果预先计算并存储，避免重复计算，显著提高加密速度。

### 2. 循环展开优化
- **优化点**：32轮迭代采用4轮一组的循环展开
- **实现代码**：
```cpp
// 32轮迭代（展开循环减少分支预测）
for (int i = 0; i < 32; i += 4) {
    X[i + 4] = F(X[i], X[i + 1], X[i + 2], X[i + 3], roundKeys[i]);
    X[i + 5] = F(X[i + 1], X[i + 2], X[i + 3], X[i + 4], roundKeys[i + 1]);
    X[i + 6] = F(X[i + 2], X[i + 3], X[i + 4], X[i + 5], roundKeys[i + 2]);
    X[i + 7] = F(X[i + 3], X[i + 4], X[i + 5], X[i + 6], roundKeys[i + 3]);
}
```
- **优势**：减少循环控制开销和分支预测错误，提高CPU指令流水线效率，充分利用处理器的并行计算能力。

### 3. 密钥扩展优化
- **优化点**：密钥扩展过程使用预计算的T'表
- **实现代码**：
```cpp
// 使用 T' 表优化的密钥扩展
T = T0_prime[(T >> 24) & 0xFF] ^
    T1_prime[(T >> 16) & 0xFF] ^
    T2_prime[(T >> 8) & 0xFF] ^
    T3_prime[T & 0xFF];
```
- **优势**：传统实现中每次密钥扩展需要调用tau_transform和linear_transform_Lprime函数，优化版本通过查表直接获取结果，减少函数调用开销。

### 4. 内存布局优化
- **优化点**：使用`std::array`替代普通数组存储轮密钥和中间状态
- **实现代码**：
```cpp:/d:/18403/MyWork/CST_SummerCourse/Project/SDU_CST_Course/Project01_SM4/Sm4_Implementation/sm4_one.cpp
std::array<unsigned int, 32> roundKeys;
std::array<unsigned int, 36> K;
```
- **优势**：提供更好的内存管理和缓存局部性，减少内存访问延迟，提高数据访问效率。

## 测试验证
测试函数使用相同的密钥（0x0123456789ABCDEFEDCBA9876543210）和明文，分别对传统SM4和优化SM4进行加密解密验证，确保优化版本在提高性能的同时保持算法正确性。
        